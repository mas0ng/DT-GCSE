<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D viewer</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root { --bg:#0b1220; --fg:#eaf1ff; --muted:#9db0d6; --accent:#4ea1ff; }
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;overflow:hidden}
    #viewer{position:fixed;inset:0}
    canvas{display:block;width:100%;height:100%}
    .credit{position:absolute;right:10px;bottom:10px;font-size:.8rem;color:var(--muted);opacity:.85}
    .credit a{color:var(--accent);text-decoration:none}
    #toast{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:#0009;border:1px solid #ffffff29;
           padding:.5rem .75rem;border-radius:10px;font-size:.9rem;opacity:0;transition:opacity .2s;max-width:92vw}
    #toast.show{opacity:1}
    #err{position:fixed;inset:auto 12px 12px 12px;background:#2a0f13;border:1px solid #ff6b6b55;color:#ffd7d7;
         padding:.8rem 1rem;border-radius:12px;font-size:.92rem;display:none;white-space:pre-wrap}
    #err b{color:#fff}
  </style>
</head>
<body>
  <div id="viewer">
    <div id="toast"></div>
    <div id="err"></div>
    <div class="credit">Powered by <a href="https://threejs.org/" target="_blank" rel="noopener">three.js</a></div>
  </div>

  <!-- Pinned r128 CDNs for long-term stability -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js" defer></script>

  <script defer>
    const toast = (t,ms=1600)=>{ const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show');
      clearTimeout(el._to); el._to=setTimeout(()=>el.classList.remove('show'), ms); };
    const showErr = (txt)=>{ const el=document.getElementById('err'); el.textContent=txt; el.style.display='block'; };

    // Read ?ref=<name>  → assets/<ref>/model.obj + model.mtl (+ textures referenced in .mtl)
    function getRef(){
      const p = new URLSearchParams(location.search);
      const ref = (p.get('ref')||'').trim();
      return ref || null;
    }

    function getFolderURLForRef(ref){
      // Ensures correct resolution under GitHub Pages project paths
      return new URL(`assets/${encodeURIComponent(ref)}/`, location.href).href;
    }

    function checkLibs(){
      if(typeof THREE === 'undefined'){
        showErr("Failed to load three.js.\nCheck network/CSP and that the CDN is reachable.");
        throw new Error('THREE undefined');
      }
      if(typeof THREE.OBJLoader === 'undefined'){
        showErr("Failed to load OBJLoader.js for this three.js version.");
        throw new Error('OBJLoader missing');
      }
      if(typeof THREE.MTLLoader === 'undefined'){
        showErr("Failed to load MTLLoader.js for this three.js version.");
        throw new Error('MTLLoader missing');
      }
      if(typeof THREE.OrbitControls === 'undefined'){
        showErr("Failed to load OrbitControls.js for this three.js version.");
        throw new Error('OrbitControls missing');
      }
    }

    let renderer, scene, camera, controls, model;

    function init(){
      document.title = '3D viewer'; // ensure title is always exactly this
      checkLibs();

      const ref = getRef();
      if(!ref){
        showErr(`No ref provided.\n\nUsage:\n${location.pathname.split('/').pop()}?ref=box\n\nExpected files:\nassets/box/model.obj\nassets/box/model.mtl\n(+ any textures referenced by model.mtl)`);
        return;
      }

      const viewer = document.getElementById('viewer');
      const w = window.innerWidth, h = window.innerHeight;

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(w,h); viewer.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(50, w/h, 0.01, 2000);
      camera.position.set(2.5, 1.6, 3.2);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.target.set(0,0.8,0);

      scene.add(new THREE.AmbientLight(0xffffff, .6));
      const key = new THREE.DirectionalLight(0xffffff, 1.2); key.position.set(5,6,8); scene.add(key);
      const rim = new THREE.DirectionalLight(0xffffff, .6);  rim.position.set(-6,4,-6); scene.add(rim);

      loadOBJWithMTL(ref);

      window.addEventListener('resize', ()=>{
        const W = window.innerWidth, H = window.innerHeight;
        renderer.setSize(W,H); camera.aspect = W/H; camera.updateProjectionMatrix();
      });

      (function animate(){
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      })();
    }

    function loadOBJWithMTL(ref){
      const folder = getFolderURLForRef(ref);         // e.g. .../assets/box/
      const objUrl = new URL('model.obj', folder).href;
      const mtlUrl = new URL('model.mtl', folder).href;

      toast(`Loading "${ref}"…`);
      console.log('Loading MTL:', mtlUrl);
      console.log('Loading OBJ:', objUrl);

      const mtlLoader = new THREE.MTLLoader();
      mtlLoader.setResourcePath(folder);  // so texture paths in .mtl resolve within this folder
      mtlLoader.setPath(folder);          // for .mtl internal references

      mtlLoader.load(mtlUrl, (materials)=>{
        materials.preload();
        const objLoader = new THREE.OBJLoader();
        objLoader.setMaterials(materials);
        objLoader.setPath(folder);
        objLoader.load('model.obj', (obj)=>{
          model = obj; scene.add(model);
          normalizeModel(); frameModel();
          toast('Model loaded');
        }, undefined, (err)=>{
          console.error('OBJ load error:', err);
          showErr(errorNote(ref, objUrl, 'OBJ'));
        });
      }, undefined, (err)=>{
        console.warn('MTL load failed, attempting raw OBJ without materials.', err);
        // Fallback: try loading OBJ anyway (will appear grey)
        const objLoader = new THREE.OBJLoader();
        objLoader.setPath(folder);
        objLoader.load('model.obj', (obj)=>{
          model = obj; scene.add(model);
          normalizeModel(); frameModel();
          toast('Model loaded (no .mtl found)');
        }, undefined, (e)=>{
          console.error('OBJ load error (fallback):', e);
          showErr(errorNote(ref, objUrl, 'OBJ/MTL'));
        });
      });
    }

    function errorNote(ref, triedURL, kind){
      return `Could not load ${kind} for ref="${ref}".

URL tried:
${triedURL}

Check:
• The folder exists: assets/${ref}/
• The files exist and are spelled exactly: model.obj, model.mtl (case-sensitive on GitHub Pages)
• Any textures referenced in model.mtl are in the same folder.
• Open the OBJ/MTL URLs directly in a new tab to verify they don’t 404.`;
    }

    function normalizeModel(){
      if(!model) return;
      const box = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      model.position.sub(center);
      const maxDim = Math.max(size.x,size.y,size.z) || 1;
      const scale = 1.4 / maxDim; model.scale.setScalar(scale);
    }

    function frameModel(){
      if(!model){ controls.target.set(0,0,0); return; }
      const box = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      controls.target.copy(center);
      const maxDim = Math.max(size.x,size.y,size.z);
      const fitDist = maxDim / (2*Math.tan((Math.PI*camera.fov)/360));
      const dir = new THREE.Vector3(2.5,1.6,3.2).normalize();
      camera.position.copy(center.clone().add(dir.multiplyScalar(fitDist*1.6)));
      camera.near = Math.max(0.01, maxDim/1000);
      camera.far  = Math.max(500,  maxDim*10);
      camera.updateProjectionMatrix(); controls.update();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
