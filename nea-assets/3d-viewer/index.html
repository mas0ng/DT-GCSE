<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D viewer</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root { --bg:#0b1220; --fg:#eaf1ff; --muted:#9db0d6; --accent:#4ea1ff; }
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;overflow:hidden}
    #viewer{position:fixed;inset:0}
    canvas{display:block;width:100%;height:100%}
    .credit{position:absolute;right:10px;bottom:10px;font-size:.8rem;color:var(--muted);opacity:.85}
    .credit a{color:var(--accent);text-decoration:none}
    #toast{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:#0009;border:1px solid #ffffff29;
           padding:.5rem .75rem;border-radius:10px;font-size:.9rem;opacity:0;transition:opacity .2s;max-width:92vw}
    #toast.show{opacity:1}
    #err{position:fixed;inset:auto 12px 12px 12px;background:#2a0f13;border:1px solid #ff6b6b55;color:#ffd7d7;
         padding:.8rem 1rem;border-radius:12px;font-size:.92rem;display:none;white-space:pre-wrap}
    #err b{color:#fff}
  </style>
</head>
<body>
  <div id="viewer">
    <div id="toast"></div>
    <div id="err"></div>
    <div class="credit">Powered by <a href="https://threejs.org/" target="_blank" rel="noopener">three.js</a></div>
  </div>

  <!-- Pinned r128 CDNs for long-term stability -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js" defer></script>

  <script defer>
    const toast = (t,ms=1600)=>{ const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show');
      clearTimeout(el._to); el._to=setTimeout(()=>el.classList.remove('show'), ms); };
    const showErr = (txt)=>{ const el=document.getElementById('err'); el.textContent=txt; el.style.display='block'; };

    function getRef(){
      const p = new URLSearchParams(location.search);
      const ref = (p.get('ref')||'').trim();
      return ref || null;
    }
    function folderFor(ref){
      // Absolute URL to the assets folder (handles GH Pages subpaths)
      return new URL(`assets/${encodeURIComponent(ref)}/`, location.href).href;
    }

    function checkLibs(){
      if(typeof THREE === 'undefined') throw new Error('THREE undefined');
      if(!THREE.OrbitControls) throw new Error('OrbitControls missing');
      // GLTF is preferred, but we also include OBJ/MTL as fallback
      if(!THREE.GLTFLoader) throw new Error('GLTFLoader missing');
      if(!THREE.OBJLoader) console.warn('OBJLoader missing (fallback will not work).');
      if(!THREE.MTLLoader) console.warn('MTLLoader missing (materials for OBJ will not work).');
    }

    let renderer, scene, camera, controls, model;

    function init(){
      document.title = '3D viewer';
      try { checkLibs(); } catch(e){
        showErr("Failed to load a required three.js script. Check your network/CSP and CDN reachability.");
        console.error(e);
        return;
      }

      const ref = getRef();
      if(!ref){
        showErr(`No ref provided.\n\nPlease ensure that you are using an official link / QR Code`);
        return;
      }

      // Scene setup
      const viewer = document.getElementById('viewer');
      const w = window.innerWidth, h = window.innerHeight;
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(w,h); viewer.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(50, w/h, 0.01, 2000);
      camera.position.set(2.5, 1.6, 3.2);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.target.set(0,0.8,0);

      scene.add(new THREE.AmbientLight(0xffffff, .6));
      const key = new THREE.DirectionalLight(0xffffff, 1.2); key.position.set(5,6,8); scene.add(key);
      const rim = new THREE.DirectionalLight(0xffffff, .6);  rim.position.set(-6,4,-6); scene.add(rim);

      loadModel(ref);

      window.addEventListener('resize', ()=>{
        const W = window.innerWidth, H = window.innerHeight;
        renderer.setSize(W,H); camera.aspect = W/H; camera.updateProjectionMatrix();
      });

      (function animate(){
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      })();
    }

    function loadModel(ref){
      const folder = folderFor(ref); // e.g., .../assets/box/
      const glbUrl = new URL('model.glb', folder).href;

      toast(`Loading "${ref}" (GLB)…`);
      console.log('Trying GLB:', glbUrl);

      const gltfLoader = new THREE.GLTFLoader();
      gltfLoader.load(glbUrl, (gltf)=>{
        // GLB success
        model = gltf.scene || gltf.scenes?.[0];
        if(!model){ showErr('GLB loaded but scene is empty.'); return; }
        scene.add(model);
        normalizeModel(); frameModel();
        toast('GLB loaded');
      }, undefined, (glbErr)=>{
        console.warn('GLB load failed, trying OBJ+MTL fallback.', glbErr);
        loadOBJWithMTL(ref, folder);
      });
    }

    function loadOBJWithMTL(ref, folder){
      const objUrl = new URL('model.obj', folder).href;
      const mtlUrl = new URL('model.mtl', folder).href;

      toast(`Loading "${ref}" (OBJ+MTL)…`);
      console.log('MTL:', mtlUrl);
      console.log('OBJ:', objUrl);

      if(!THREE.MTLLoader || !THREE.OBJLoader){
        showErr(`GLB not found and OBJ/MTL loaders missing.\nPlease provide model.glb in assets/${ref}/ or include MTL/OBJ loaders.`);
        return;
      }

      const mtlLoader = new THREE.MTLLoader();
      mtlLoader.setResourcePath(folder);
      mtlLoader.setPath(folder);

      mtlLoader.load('model.mtl', (materials)=>{
        materials.preload();
        const objLoader = new THREE.OBJLoader();
        objLoader.setMaterials(materials);
        objLoader.setPath(folder);
        objLoader.load('model.obj', (obj)=>{
          model = obj; scene.add(model);
          normalizeModel(); frameModel();
          toast('OBJ+MTL loaded');
        }, undefined, (err)=>{
          console.error('OBJ load error:', err);
          showErr(errorNote(ref, objUrl, 'OBJ'));
        });
      }, undefined, (mtlErr)=>{
        console.warn('MTL load failed, loading raw OBJ (grey).', mtlErr);
        const objLoader = new THREE.OBJLoader();
        objLoader.setPath(folder);
        objLoader.load('model.obj', (obj)=>{
          model = obj; scene.add(model);
          normalizeModel(); frameModel();
          toast('OBJ loaded (no .mtl)');
        }, undefined, (objErr)=>{
          console.error('OBJ load error (fallback):', objErr);
          showErr(errorNote(ref, objUrl, 'OBJ/MTL'));
        });
      });
    }

    function errorNote(ref, triedURL, kind){
      return `Could not load ${kind} for ref="${ref}".

URL tried:
${triedURL}

Check:
• Folder exists: assets/${ref}/
• For GLB: file exists as model.glb
• For OBJ: files exist and are spelled exactly: model.obj, model.mtl (case-sensitive)
• Any textures referenced in model.mtl are in the same folder
• Open the GLB/OBJ/MTL URLs directly in a new tab to verify they don’t 404.`;
    }

    function normalizeModel(){
      if(!model) return;
      const box = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      model.position.sub(center);
      const maxDim = Math.max(size.x,size.y,size.z) || 1;
      const scale = 1.4 / maxDim; model.scale.setScalar(scale);
    }

    function frameModel(){
      if(!model){ controls.target.set(0,0,0); return; }
      const box = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      controls.target.copy(center);
      const maxDim = Math.max(size.x,size.y,size.z);
      const fitDist = maxDim / (2*Math.tan((Math.PI*camera.fov)/360));
      const dir = new THREE.Vector3(2.5,1.6,3.2).normalize();
      camera.position.copy(center.clone().add(dir.multiplyScalar(fitDist*1.6)));
      camera.near = Math.max(0.01, maxDim/1000);
      camera.far  = Math.max(500,  maxDim*10);
      camera.updateProjectionMatrix(); controls.update();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
